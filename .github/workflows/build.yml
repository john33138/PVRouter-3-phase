# CI workflow for PVRouter-3-phase
# Runs build and tests on push/PR to main and dev branches

name: CI
permissions:
  contents: read

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  PROJECT_DIR: Mk2_3phase_RFdatalog_temp

jobs:
  # Setup job: installs dependencies and populates cache
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Install PlatformIO libraries
        run: pio pkg install --project-dir ${{ env.PROJECT_DIR }}

  # Build job: compiles firmware for embedded targets
  build:
    name: Build Firmware
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Build firmware
        run: pio run --project-dir ${{ env.PROJECT_DIR }}

  # Native test jobs: runs each native test separately
  test-native:
    name: Native (${{ matrix.test }})
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test:
          - test_ewma_avg
          - test_utils_override
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Run ${{ matrix.test }}
        run: pio test --project-dir ${{ env.PROJECT_DIR }} -e native -f "*${{ matrix.test }}*"

  # Embedded test jobs: runs each test in Wokwi simulator
  test-embedded:
    name: Embedded (${{ matrix.test }})
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test:
          - test_fastdivision
          - test_utils_pins
          - test_utils_relay
          - test_teleinfo
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Build test firmware
        run: pio test --project-dir ${{ env.PROJECT_DIR }} -e uno -f "*${{ matrix.test }}*" --without-uploading --without-testing

      - name: Run ${{ matrix.test }} in Wokwi
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          wokwi-cli --timeout 60000 \
            --expect-text "OK" \
            --fail-text "FAIL" \
            --diagram-file ../diagram.json \
            --elf ${{ env.PROJECT_DIR }}/.pio/build/uno/firmware.elf \
            --serial-log-file wokwi-output.txt \
            ${{ env.PROJECT_DIR }}/test/embedded/${{ matrix.test }}

      - name: Show test results
        if: always()
        run: |
          echo "### ${{ matrix.test }} Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Extract just the test results (lines with PASS/FAIL and summary)
          grep -E "(PASS|FAIL|Tests.*Failures.*Ignored|OK$)" wokwi-output.txt | head -50 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test }}-output
          path: wokwi-output.txt
