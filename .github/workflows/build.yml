# CI workflow for PVRouter-3-phase
# Runs build and tests on all branches and PRs
# Skips CI for documentation-only changes

name: CI
permissions:
  contents: read
  checks: write

on:
  push:
    branches: [ '**' ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main, dev ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

env:
  PROJECT_DIR: Mk2_3phase_RFdatalog_temp

jobs:
  # Setup job: installs dependencies and populates cache
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Install PlatformIO libraries
        run: pio pkg install --project-dir ${{ env.PROJECT_DIR }}

  # Build job: compiles firmware for embedded targets
  build:
    name: Build Firmware
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Build firmware
        run: pio run --project-dir ${{ env.PROJECT_DIR }}

  # Native test jobs: runs each native test separately
  test-native:
    name: Native (${{ matrix.test }})
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test:
          - test_ewma_avg
          - test_utils_override
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Run ${{ matrix.test }}
        run: pio test --project-dir ${{ env.PROJECT_DIR }} -e native -f "*${{ matrix.test }}*"

  # Embedded test jobs: runs each test in Wokwi simulator
  test-embedded:
    name: Embedded (${{ matrix.test }})
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test:
          - test_fastdivision
          - test_utils_pins
          - test_utils_relay
          - test_teleinfo
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Install Wokwi CLI
        run: |
          curl -L https://wokwi.com/ci/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "$HOME/.wokwi/bin" >> $GITHUB_PATH

      - name: Build test firmware
        run: pio test --project-dir ${{ env.PROJECT_DIR }} -e uno -f "*${{ matrix.test }}*" --without-uploading --without-testing

      - name: Run ${{ matrix.test }} in Wokwi
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          wokwi-cli --timeout 60000 \
            --expect-text "OK" \
            --fail-text "FAIL" \
            --diagram-file ../diagram.json \
            --elf ${{ env.PROJECT_DIR }}/.pio/build/uno/firmware.elf \
            --serial-log-file wokwi-output.txt \
            ${{ env.PROJECT_DIR }}/test/embedded/${{ matrix.test }}

      - name: Convert Unity output to JUnit XML
        if: always()
        run: |
          # Convert Unity test output to JUnit XML format
          python3 << 'EOF'
          import re
          import sys
          from xml.etree.ElementTree import Element, SubElement, tostring
          from xml.dom import minidom

          with open('wokwi-output.txt', 'r', encoding='utf-8', errors='ignore') as f:
              content = f.read()

          # Parse Unity output
          test_pattern = r'([^:]+):(\d+):([^:]+):(PASS|FAIL)'
          summary_pattern = r'(\d+) Tests (\d+) Failures (\d+) Ignored'

          tests = re.findall(test_pattern, content)
          summary = re.search(summary_pattern, content)

          # Build JUnit XML
          testsuites = Element('testsuites')
          testsuite = SubElement(testsuites, 'testsuite')
          testsuite.set('name', '${{ matrix.test }}')
          testsuite.set('tests', str(len(tests)))

          failures = 0
          for file, line, name, result in tests:
              testcase = SubElement(testsuite, 'testcase')
              testcase.set('name', name)
              testcase.set('classname', file.split('/')[-1])
              if result == 'FAIL':
                  failures += 1
                  failure = SubElement(testcase, 'failure')
                  failure.set('message', f'Test failed at {file}:{line}')

          testsuite.set('failures', str(failures))

          # Pretty print
          xml_str = minidom.parseString(tostring(testsuites)).toprettyxml(indent="  ")
          with open('test-results.xml', 'w') as f:
              f.write(xml_str)
          EOF

      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: ${{ matrix.test }}
          path: test-results.xml
          reporter: java-junit

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test }}-output
          path: |
            wokwi-output.txt
            test-results.xml
