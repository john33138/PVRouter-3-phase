# CI workflow for PVRouter-3-phase
# Runs build and tests on push/PR to main and dev branches

name: CI
permissions:
  contents: read

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  PROJECT_DIR: Mk2_3phase_RFdatalog_temp

jobs:
  # Setup job: installs dependencies and populates cache
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Install PlatformIO libraries
        run: pio pkg install --project-dir ${{ env.PROJECT_DIR }}

  # Build job: compiles firmware for embedded targets
  build:
    name: Build Firmware
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Build firmware
        run: pio run --project-dir ${{ env.PROJECT_DIR }}

  # Test job: runs native unit tests
  test-native:
    name: Native Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Run native tests
        run: pio test --project-dir ${{ env.PROJECT_DIR }} -e native

  # Embedded test job: runs tests in Wokwi simulator
  # Runs sequentially since all tests share the same build directory
  test-embedded:
    name: Embedded Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Run embedded tests with Wokwi
        env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
        run: |
          # Install Wokwi CLI
          curl -L https://wokwi.com/ci/install.sh | sh
          export PATH="$HOME/bin:$HOME/.wokwi/bin:$PATH"

          # Run each embedded test sequentially
          for test in test_fastdivision test_utils_pins test_utils_relay test_teleinfo; do
            echo "=========================================="
            echo "Running $test"
            echo "=========================================="

            # Build the test firmware
            pio test --project-dir ${{ env.PROJECT_DIR }} -e uno -f "*${test}*" --without-uploading --without-testing

            # Run in Wokwi simulator
            wokwi-cli --timeout 60000 \
              --expect-text "OK" \
              --fail-text "FAIL" \
              --diagram-file ${{ env.PROJECT_DIR }}/test/embedded/diagram.json \
              --elf ${{ env.PROJECT_DIR }}/.pio/build/uno/firmware.elf \
              ${{ env.PROJECT_DIR }}/test/embedded/${test}
          done
