# CI workflow for PVRouter-3-phase
# Runs build and tests on push/PR to main and dev branches

name: CI
permissions:
  contents: read

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  PROJECT_DIR: Mk2_3phase_RFdatalog_temp

jobs:
  # Setup job: installs dependencies and populates cache
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Install PlatformIO libraries
        run: pio pkg install --project-dir ${{ env.PROJECT_DIR }}

  # Build job: compiles firmware for embedded targets
  build:
    name: Build Firmware
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Build firmware
        run: pio run --project-dir ${{ env.PROJECT_DIR }}

  # Test job: runs native unit tests
  test:
    name: Run Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '>=3.11'

      - name: Restore PlatformIO cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Run native tests
        run: pio test --project-dir ${{ env.PROJECT_DIR }} -e native
